syntax = "proto3";

package io.restorecommerce.fulfillment;

import "google/protobuf/any.proto";
import "io/restorecommerce/resource_base.proto";
import "io/restorecommerce/auth.proto";
import "io/restorecommerce/status.proto";
import "io/restorecommerce/address.proto";
import "io/restorecommerce/country.proto";

/**
Microservice definition.
*/
service Service {
  /**
  Returns a list of shipment IDs.
  */
  rpc Read (io.restorecommerce.resourcebase.ReadRequest) returns (FulfillmentResponseList);

  /**
  Creates but does not execute fulfillment orders
  */
  rpc Create (FulfillmentRequestList) returns (FulfillmentResponseList);

  /**
  Updates but does not execute fulfillment orders
  */
  rpc Update (FulfillmentRequestList) returns (FulfillmentResponseList);

  /**
  Upserts but does not execute fulfillment orders
  */
  rpc Upsert (FulfillmentRequestList) returns (FulfillmentResponseList);

  /**
  Executes and Upserts fulfillment orders
  */
  rpc Order (FulfillmentRequestList) returns (FulfillmentResponseList);

  /**
  Track a batch of fulfillment orders
  */
  rpc Track (TrackingRequestList) returns (TrackingResultList);

  /**
  Cancel a batch of fulfillment orders
  */
  rpc Cancel (CancelRequestList) returns (CancelResultList);

  /**
  Delete a batch of fulfillments from the database
  */
  rpc Delete (io.restorecommerce.resourcebase.DeleteRequest) returns (io.restorecommerce.resourcebase.DeleteResponse);
}

enum State {
  Incomplete = 0;
  Ordered = 1;
  Processing = 2;
  Done=3;
  Cancelled = 4;
  Failed = 5;
}

message Origin {
  string country = 1;
  string iso_code = 2;
}

message Contact {
  string name = 1;
  string email = 2;
  string phone = 3;
}

message Branch {
  string branch_number = 1;
  string post_number = 2;
}

message Packstation {
  string station_number = 1;
  string post_number = 2;
}

message Address {
  string title = 1;
  repeated string name = 2;
  oneof type {
    io.restorecommerce.address.Address address = 3;
    Packstation packstation = 4;
    Branch branch = 5;
  };
  io.restorecommerce.counrty country = 6;
  Contact contact = 7;
}

message Parcel {
  int32 quantity = 1;
  float weight = 2;
  float height = 3;
  float width = 4;
  float length = 5;
}

message Order {
  repeated Parcel parcels = 1;
  Address sender = 2;
  Address receiver = 3;
  string notify = 5;
}

message Label {
  oneof type {
    string url = 1;
    string pdf = 2;
    string png = 3;
  }
  string shipment_id = 4; //filled on Order
  State state = 5; //update by Track
  io.restorecommerce.status.Status status = 6; //API status
}

message Event {
  io.restorecommerce.status.Status status = 1;
  string timestamp = 2;
  string location = 3;
  google.protobuf.Any details = 4;
}

message FulfillmentRequest {
  string id = 1;
  string courier_id = 2;
  string product_id = 3;
  Order order = 4;
  io.restorecommerce.meta.Meta meta = 5;
}

message FulfillmentRequestList {
  repeated FulfillmentRequest items = 1;
  uint32 total_count = 2;
  io.restorecommerce.auth.Subject subject = 3;
}

/**
This is the message how it get stored to the database
*/
message Fulfillment {
  string id = 1;
  string courier_id = 2;
  string product_id = 3;
  Order order = 4;
  io.restorecommerce.meta.Meta meta = 5;
  Label label = 6; //filled on Order
}

message FulfillmentResponse {
  Fulfillment payload = 1;
  io.restorecommerce.status.Status status = 2;
}

message FulfillmentResponseList {
  repeated FulfillmentResponse items = 1;
  uint32 total_count = 2;
  io.restorecommerce.status.OperationStatus operation_status = 3;
}

message TrackingRequest {
  string order_id = 1;
  google.protobuf.Any options = 2;
}

message TrackingRequestList {
  repeated TrackingRequest items = 1;
  io.restorecommerce.auth.Subject subject = 2;
}

message Tracking {
  string fulfillment_id = 1;
  repeated Event events = 2;
  google.protobuf.Any details = 3;
  io.restorecommerce.status.Status status = 4;
}

message TrackingResultList {
  repeated Tracking items = 1;
  io.restorecommerce.status.OperationStatus operation_status = 2;
}

message CancelRequestList {
  repeated string ids = 1;
  io.restorecommerce.auth.Subject subject = 2;
}

message CancelResultList {
  repeated io.restorecommerce.status.Status items = 1;
  io.restorecommerce.status.OperationStatus operation_status = 2;
}

message Deleted {
  string id = 1;
}